<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="消息队列基础, Wenjun">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>消息队列基础 | Wenjun</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Wenjun" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Wenjun</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Wenjun</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/wenjunnie" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/wenjunnie" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/5.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">消息队列基础</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    .toc-fixed .toc-link::before{
        position: fixed!important;/*当toc的位置改为fixed时，.toc-link::before也要改为fixed*/
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">
                                <span class="chip bg-color">消息队列</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" class="post-category">
                                分布式
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-05-09
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    7.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    26 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="消息队列基础"><a href="#消息队列基础" class="headerlink" title="消息队列基础"></a>消息队列基础</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><strong>消息队列</strong>在互联网技术存储方面使用如此广泛，几乎所有的后端技术面试官都要在<strong>消息队列</strong>的使用和原理方面对小伙伴们进行 360° 的刁难。</p>
<p>作为一个在互联网公司面一次拿一次 offer 的面霸，打败了无数竞争对手，每次都只能看到无数落寞的身影失望的离开，略感愧疚（<strong>请允许我使用一下夸张的修辞手法</strong>）。</p>
<p>于是在一个寂寞难耐的夜晚，<strong>暖男</strong>我痛定思痛，决定开始写<strong>《吊打面试官》</strong>系列，希望能帮助各位读者以后面试势如破竹，对面试官进行 360° 的反击，吊打问你的面试官，让一同面试的同僚瞠目结舌，疯狂收割大厂 offer ！</p>
<h2 id="面试开始"><a href="#面试开始" class="headerlink" title="面试开始"></a>面试开始</h2><blockquote>
<p>一个风度翩翩，穿着格子衬衣的中年男子，拿着一个满是划痕的 Mac 向你走来，看着铮亮的头，心想着肯定是尼玛顶级架构师吧！但是我们腹有诗书气自华，虚都不虚。</p>
</blockquote>
<p><img src="https://s1.ax1x.com/2020/05/08/YMSlLR.jpg" alt=""></p>
<h3 id="你项目中用过消息队列么？你为啥用消息队列？"><a href="#你项目中用过消息队列么？你为啥用消息队列？" class="headerlink" title="你项目中用过消息队列么？你为啥用消息队列？"></a>你项目中用过消息队列么？你为啥用消息队列？</h3><p>噗此，这也叫问题？别人用了我能不用么？别人用了我就用了呗，我就是为了用而用。</p>
<p>面试官你好：我们公司本身的业务体量很小，所以直接<strong>单机一把梭</strong>啥都能搞定了，但是后面业务体量不断扩大，采用<strong>微服务的设计思想</strong>，<strong>分布式的部署方式</strong>，所以拆分了很多的服务，随着体量的增加以及业务场景越来越复杂了，很多场景单机的技术栈和中间件以及不够用了，而且对系统的友好性也下降了，最后做了很多技术选型的工作，我们决定引入<strong>消息队列中间件</strong>。</p>
<h3 id="哦？你说到业务场景越来越复杂，你那说一下你都在什么场景用到了消息队列？"><a href="#哦？你说到业务场景越来越复杂，你那说一下你都在什么场景用到了消息队列？" class="headerlink" title="哦？你说到业务场景越来越复杂，你那说一下你都在什么场景用到了消息队列？"></a>哦？你说到业务场景越来越复杂，你那说一下你都在什么场景用到了消息队列？</h3><p>嗯，我从三个方面去说一下我使用的场景吧。</p>
<blockquote>
<p><strong>Tips：</strong>这三个场景也是消息队列的经典场景，大家基本上要烂熟于心那种，就是一说到消息队列你脑子就要想到<strong>异步、削峰、解耦</strong>，条件反射那种。</p>
</blockquote>
<h4 id="异步："><a href="#异步：" class="headerlink" title="异步："></a>异步：</h4><p>我们之前的场景里面有很多步骤都是在一个流程里面需要做完的，就比如说我的下单系统吧，本来我们业务简单，下单了付了钱就好了，流程就走完了。</p>
<p>但是后面来了个产品经理，搞了个<strong>优惠券系统</strong>，OK 问题不大，流程里面多 100ms 去扣减优惠券。</p>
<p>后来产品经理灵光一闪说我们可以搞个<strong>积分系统</strong>啊，也行吧，流程里面多了 200ms 去增减积分。</p>
<p>再后来后来隔壁的产品老王说：下单成功后我们要给用户发短信，也将就吧，100ms 去发个短信。</p>
<p>再后来。。。</p>
<p><img src="https://s1.ax1x.com/2020/05/08/YMSwyd.jpg" alt=""></p>
<p>反正就流程有点像这样 ↓</p>
<p><img src="https://s1.ax1x.com/2020/05/08/YMSgfS.jpg" alt=""></p>
<p>你们可以看到这才加了三个，我可以<strong>斩钉截铁</strong>的告诉你真正的下单流程涉及的系统绝对在 10 个以上（主流电商），越大的越多。</p>
<p>这个链路这样下去，<strong>时间长得一批</strong>，用户发现我买个东西你特么要花几十秒，垃圾电商我不在你这里买了，不过要是都像<strong>拼夕夕</strong>这么便宜，<strong>真香</strong>！</p>
<p>但是我们公司没有夕夕的那个经济实力啊，那只能优化系统了。</p>
<p><img src="https://s1.ax1x.com/2020/05/08/YMSjX9.jpg" alt=""></p>
<p><strong>大家感受一下这个 QPS 。</strong></p>
<h3 id="嗯不错，链路长了就慢了，那你怎么解决的？"><a href="#嗯不错，链路长了就慢了，那你怎么解决的？" class="headerlink" title="嗯不错，链路长了就慢了，那你怎么解决的？"></a>嗯不错，链路长了就慢了，那你怎么解决的？</h3><p>那链路长了就慢了，但是我们发现上面的流程其实可以<strong>同时做</strong>的呀，你支付成功后，我去校验优惠券的同时我可以去增减积分啊，还可以同时发个短信啊。</p>
<p>那正常的流程我们是没办法实现的呀，怎么办，<strong>异步</strong>。</p>
<p>你对比一下是不是发现，这样子最多只用 100ms 用户知道下单成功了，至于短信你迟几秒发给他他根本不在意是吧。</p>
<p><img src="https://s1.ax1x.com/2020/05/08/YMp09U.jpg" alt=""></p>
<h3 id="小伙子我打断你一下，你说了异步，那我用线程，线程池去做不是一样的么？"><a href="#小伙子我打断你一下，你说了异步，那我用线程，线程池去做不是一样的么？" class="headerlink" title="小伙子我打断你一下，你说了异步，那我用线程，线程池去做不是一样的么？"></a>小伙子我打断你一下，你说了异步，那我用线程，线程池去做不是一样的么？</h3><p>诶呀，面试官你<strong>不要急嘛</strong>，我后面还会说到的，骚等。</p>
<h4 id="解耦："><a href="#解耦：" class="headerlink" title="解耦："></a>解耦：</h4><p>既然面试官这么问了，我就说一下为啥我们不能用线程去做，因为用线程去做，你是不是要写代码？</p>
<p>你一个订单流程，你扣积分，扣优惠券，发短信，扣库存。。。等等这么多业务要调用这么多的接口，<strong>每次加一个你要调用一个接口然后还要重新发布系统</strong>，写一次两次还好，写多了你就说：老子不干了！</p>
<p>而且真的全部都写在一起的话，不单单是耦合这一个问题，你出问题排查也麻烦，流程里面随便一个地方出问题搞不好会影响到其他的点，小伙伴说我每个流程都 <strong>try catch</strong> 不就行了，相信我别这么做，这样的代码就像个<strong>定时炸弹💣</strong>，你不知道什么时候爆炸，平时不炸偏偏在你做活动的时候炸，你就领个 <strong>P0 故障</strong>收拾书包<strong>提前回家过年</strong>吧。</p>
<p>但是你用了<strong>消息队列</strong>，耦合这个问题就迎刃而解了呀。</p>
<h3 id="哦，怎么说？"><a href="#哦，怎么说？" class="headerlink" title="哦，怎么说？"></a>哦，怎么说？</h3><p>且听我娓娓道来：</p>
<p>你下单了，你就把你<strong>支付成功的消息告诉别的系统</strong>，它们收到了去处理就好了，你只用走完自己的流程，把自己的消息发出去，那后面要接入什么系统简单，直接订阅你发送的支付成功消息，你支付成功了我<strong>监听就好了</strong>。</p>
<p><img src="https://s1.ax1x.com/2020/05/08/YM9Z2F.jpg" alt=""></p>
<h3 id="那你的流程走完了，你不用管别人是否成功么？比如你下单了积分没加，优惠券没扣怎么办？"><a href="#那你的流程走完了，你不用管别人是否成功么？比如你下单了积分没加，优惠券没扣怎么办？" class="headerlink" title="那你的流程走完了，你不用管别人是否成功么？比如你下单了积分没加，优惠券没扣怎么办？"></a>那你的流程走完了，你不用管别人是否成功么？比如你下单了积分没加，优惠券没扣怎么办？</h3><p>问题是个好问题，但是没必要考虑，业务系统本身就是自己的开发人员维护的，你积分扣失败关我下单的什么事情？你管好自己下单系统的就好了。</p>
<blockquote>
<p><strong>Tips：</strong>话是这么说，但是这其实是用了消息队列的一个缺点，涉及到<strong>分布式事务</strong>的知识点，我下面会提到。</p>
</blockquote>
<h4 id="削峰："><a href="#削峰：" class="headerlink" title="削峰："></a>削峰：</h4><p>就拿秒杀来说，你平时流量很低，但是你要做秒杀活动 00 : 00 的时候流量疯狂怼进来，你的服务器、<strong>Redis</strong> 、<strong>MySQL</strong> 各自的承受能力都不一样，你直接<strong>全部流量照单全收</strong>肯定有问题啊，直接就打挂了。</p>
<h3 id="那怎么办？"><a href="#那怎么办？" class="headerlink" title="那怎么办？"></a>那怎么办？</h3><p>简单，把请求放到队列里面，然后至于每秒消费多少请求，就看自己的<strong>服务器处理能力</strong>，你能处理 5000 QPS 你就消费这么多，可能会比正常的慢一点，但是<strong>不至于打挂服务器</strong>，等流量高峰下去了，你的服务也就没压力了。</p>
<p>你看阿里双十一 12：00 的时候这么多流量瞬间涌进去，它有时候是不是会慢一点，但是人家没挂啊，或者降级给你个友好的提示页面，等高峰过去了又是一条好汉了。</p>
<p><img src="https://s1.ax1x.com/2020/05/08/YM9oGT.jpg" alt=""></p>
<h3 id="听你说了辣么多，怎么都是好处，那我问你使用了消息队列有啥问题么？"><a href="#听你说了辣么多，怎么都是好处，那我问你使用了消息队列有啥问题么？" class="headerlink" title="听你说了辣么多，怎么都是好处，那我问你使用了消息队列有啥问题么？"></a>听你说了辣么多，怎么都是好处，那我问你使用了消息队列有啥问题么？</h3><p>诶，看过前面我写的文章的<strong>人才</strong>都知道，我经常说的就是，<strong>技术是把双刃剑</strong>！</p>
<p>没错面试官，我使用它是因为它带给我们很多好处，但是使用之后问题也是<strong>接踵而至</strong>。</p>
<p>同样的暖男我呀，也从三个点介绍它主要的缺点：</p>
<h4 id="系统复杂性"><a href="#系统复杂性" class="headerlink" title="系统复杂性"></a>系统复杂性</h4><p>本来蛮简单的一个系统，我代码随便写都没事，现在你凭空接入一个中间件在那，我是不是要考虑去维护它，而且使用的过程中是不是要考虑各种问题，比如消息<strong>重复消费</strong>、<strong>消息丢失</strong>、<strong>消息的顺序消费</strong>等等，反正用了之后就是贼烦。</p>
<h4 id="数据一致性"><a href="#数据一致性" class="headerlink" title="数据一致性"></a>数据一致性</h4><p>这个其实是分布式服务本身就存在的一个问题，<strong>不仅仅是消息队列的问题</strong>，但是放在这里说是因为用了消息队列这个问题会暴露得比较严重一点。</p>
<p>就像我开头说的，你下单的服务自己保证自己的逻辑成功处理了，你成功发了消息，但是优惠券系统，积分系统等等这么多系统，<strong>它们成功还是失败你就不管了？</strong></p>
<p>我说了保证自己的业务数据对的就好了，其实还是比较不负责任的一种说法，这样就<strong>像个渣男，没有格局</strong>，<strong>这样呀你的路会越走越窄的</strong>。</p>
<p><img src="https://s1.ax1x.com/2020/05/08/YMCFLd.jpg" alt=""></p>
<p><strong>所有的服务都成功才能算这一次下单是成功的</strong>，那怎么才能保证数据一致性呢？</p>
<p><strong>分布式事务：</strong>把下单，优惠券，积分。。。都放在一个事务里面一样，要成功一起成功，要失败一起失败。</p>
<p><img src="https://s1.ax1x.com/2020/05/08/YMCRSO.jpg" alt=""></p>
<blockquote>
<p><strong>Tips：分布式事务</strong>在互联网公司里面实在常见，我也不在这里大篇幅介绍了，后面都会专门说的。</p>
</blockquote>
<h4 id="可用性"><a href="#可用性" class="headerlink" title="可用性"></a>可用性</h4><p>你搞个系统本身没啥问题，你现在突然接入一个中间件在那放着，万一挂了怎么办？我下个单 <strong>MQ 挂了</strong>，优惠券不扣了，积分不减了，这不是杀一个程序员能搞定的吧，感觉得杀一片。</p>
<p>至于怎么保证高可用，还是那句话，也不在这里展开讨论了。</p>
<h3 id="看不出来啊，你有点东西呀，那我问一下你，你们是怎么做技术选型的？"><a href="#看不出来啊，你有点东西呀，那我问一下你，你们是怎么做技术选型的？" class="headerlink" title="看不出来啊，你有点东西呀，那我问一下你，你们是怎么做技术选型的？"></a>看不出来啊，你有点东西呀，那我问一下你，你们是怎么做技术选型的？</h3><p>目前在市面上比较主流的消息队列中间件主要有 <strong>Kafka 、ActiveMQ 、RabbitMQ 、RocketMQ</strong> 等这几种。</p>
<p>不过我想说的是，<strong>ActiveMQ</strong> 和 <strong>RabbitMQ</strong> 这两者因为吞吐量还有 <strong>GitHub</strong> 社区活跃度的原因，在各大互联网公司都已经基本上绝迹了，业务体量一般的公司会是有在用的，但是越来越多的公司更青睐 <strong>RocketMQ</strong> 这样的消息中间件了。</p>
<p><strong>Kafka</strong> 和 <strong>RocketMQ</strong> 一直在各自擅长的领域发光发亮，不过大部分公司如蚂蚁金服，字节跳动和美团，用的都是各自的中间件，可能做过修改，也可能是<strong>自研</strong>的，大多<strong>没有开源</strong>。</p>
<p>我们回归正题，我这里用网上找的对比图让大家看看差距到底在哪里：</p>
<p><img src="https://s1.ax1x.com/2020/05/08/YMPJnH.jpg" alt="主流消息队列中间件对比"></p>
<p>大家其实一下子就能看到差距了，就拿<strong>吞吐量</strong>来说，早期比较活跃的 <strong>ActiveMQ</strong> 和 <strong>RabbitMQ</strong> 基本上不是后两者的对手了，在现在这样大数据的年代<strong>吞吐量是真的很重要</strong>。</p>
<p>比如现在突然爆发了一个超级热点新闻，你的 APP 注册用户高达亿数，你要想办法第一时间把突发全部推送到每个人手上，你没有<strong>大吞吐量的消息队列</strong>中间件用啥去推？</p>
<p>再说这些用户大量涌进来看了你的新闻产生了一系列的附带流量，你怎么应对这些数据，<strong>很多场景离开消息队列基本上难以为继</strong>。</p>
<p>就<strong>部署方式</strong>而言前两者也是大不如后面两个<strong>天然分布式架构的哥哥</strong>，都是高可用的分布式架构，而且数据多个副本的数据也能做到 0 丢失。</p>
<p>我们再聊一下 <strong>RabbitMQ</strong> 这个中间件其实还行，但是这玩意开发语言居然是 <strong>Erlang</strong> ，我敢说绝大部分工程师肯定不会为了一个中间件去刻意学习一门语言的，开发维护成本你想都想不到，出个问题查都查半天。</p>
<p>至于 <strong>RocketMQ</strong>（阿里开源的），GitHub 活跃度还可以。基本上你 Push 了自己的 Bug 确认了有问题都有阿里大佬跟你试试解答并修复的，我个人推荐的也是这个，它的架构设计部分跟同样是阿里开源的一个 <strong>RPC</strong> 框架（<strong>Dubbo</strong>）是真的很像，可能是因为师出同门的原因吧。</p>
<p><strong>Kafka</strong> 我放到最后说，你们也应该知道了，压轴的这是个大哥，大数据领域，公司的日志采集，实时计算等场景，都离不开它的身影，它基本上算得上是<strong>世界范围级别的消息队列标杆</strong>了。</p>
<p>以上这些都只是一些我自己的<strong>个人意见</strong>，真正的选型还是要去<strong>深入研究</strong>的，不然那你公司一天 UV 就 1000 你告诉我你要去用 <strong>Kafka</strong> 我只能说你吃饱撑的。</p>
<p><strong>记住，没有最好的技术，只有最适合的技术，不要为了用而用</strong>。</p>
<h3 id="上次说到了消息队列的消息重复消费，你能跟我介绍这是怎么样子的场景么？"><a href="#上次说到了消息队列的消息重复消费，你能跟我介绍这是怎么样子的场景么？" class="headerlink" title="上次说到了消息队列的消息重复消费，你能跟我介绍这是怎么样子的场景么？"></a>上次说到了消息队列的消息重复消费，你能跟我介绍这是怎么样子的场景么？</h3><p>消息<strong>重复消费</strong>是使用消息队列之后，必须考虑的一个问题，也是比较严重和常见的问题，我在开发过程中，但凡用到了消息队列，我第一时间考虑的就是<strong>重复消费</strong>的问题。</p>
<p>就比如有这样的一个场景，用户下单成功后我需要去一个活动页面给他加 <strong>GMV</strong>（销售总额），最后根据他的 GMV 去给他发奖励，这是电商活动很常见的玩法。</p>
<p>类似累计下单金额到哪个梯度给你返回什么梯度的奖励这样。</p>
<p><img src="https://s1.ax1x.com/2020/05/08/YMirPx.jpg" alt=""></p>
<p>我只能告诉你这样的活动页面 <strong>10000%</strong> 是用<strong>异步</strong>去加的，不然你想，你一个用户下一单就给他加一下，那就意味着对那张表就要操作一下，你考虑下双十一当天多少次对这个表的操作？这数据库或者缓存都顶不住吧。</p>
<p>而且大家应该也有这样的体会，你下单了马上去看一些活动页面，有时候马上就有了，有时候却延迟有很久，为啥？这个速度<strong>取决于消息队列的消费速度</strong>，消费慢堵塞了就迟点看到呗。</p>
<p>你下个单<strong>支付成功</strong>你就发个消息出去，我们上面那个活动的开发人员就<strong>监听</strong>你的<strong>支付成功消息</strong>，我监听到你这个订单成功支付的消息，那我就去我活动 GMV 表里给你加上去，听到这里大家可能<strong>觉得顺理成章</strong>。</p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g982pptuarj30hz0cwmxs.jpg" alt=""></p>
<p><strong>但是</strong>我告诉大家一般消息队列的使用，我们都是有<strong>重试机制</strong>的，就是说我下游的业务发生异常了，我会抛出异常并且要求你<strong>重新发一次</strong>。</p>
<p>我这个活动这里发生错误，你要求重发肯定没问题。但是大家<strong>仔细想一下</strong>问题在哪里？</p>
<p>是的，不止你一个人监听这个消息啊，<strong>还有别的服务也在监听</strong>，它们也会失败啊，它一失败它也要求重发，但是你这里其实是成功的，重发了，你的钱不就加了两次了？</p>
<p><strong>对不对？？？是不是这个道理？？？</strong></p>
<p>还不理解？看下面  <strong>↓</strong></p>
<p><img src="https://tva1.sinaimg.cn/large/006y8mN6ly1g982ss9ku2j30ir0gcjs7.jpg" alt=""></p>
<p>就好比上面的这样，我们的<strong>积分系统处理失败</strong>了，它这个系统肯定要求你<strong>重新发送</strong>一次这个消息对吧，积分的系统重新接收并且处理成功了，但是别人的活动，优惠券等等服务<strong>也监听了这个消息</strong>呀，那不就可能出现活动系统给他加 GMV 加两次，优惠券扣两次这种情况么？</p>
<p>真实的情况其实重试是很正常的，服务的<strong>网络抖动</strong>，<strong>开发人员代码Bug</strong>，还有<strong>数据问题</strong>等都可能处理失败要求重发的。</p>
<h3 id="嗯小伙子分析得很仔细嘛，那你在开发过程中是怎么去保证的呀？"><a href="#嗯小伙子分析得很仔细嘛，那你在开发过程中是怎么去保证的呀？" class="headerlink" title="嗯小伙子分析得很仔细嘛，那你在开发过程中是怎么去保证的呀？"></a>嗯小伙子分析得很仔细嘛，那你在开发过程中是怎么去保证的呀？</h3><p>一般我们叫这样的处理叫接口<strong>幂等</strong>。</p>
<blockquote>
<p><strong>幂等（Idempotent、Idempotence）</strong>是一个数学与计算机学概念，常见于抽象代数中。</p>
<p>在编程中一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。</p>
<p>幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。</p>
<p>例如，<code>setTrue()</code> 函数就是一个幂等函数，<strong>无论多次执行，其结果都是一样的</strong>。更复杂的操作幂等保证是利用唯一交易号(流水号)实现.</p>
</blockquote>
<p>通俗了讲就是你<strong>同样的参数调用我这个接口，调用多少次结果都是一个</strong>，你加 GMV 同一个订单号你加一次是多少钱，你加 N 次都还是多少钱。</p>
<p>但是如果<strong>不做幂等</strong>，你一个订单调用多次钱不就加多次嘛，同理你退款调用多次钱也就减多次了。</p>
<p>大致处理流程如下：</p>
<p><img src="https://s1.ax1x.com/2020/05/09/YM8zzF.jpg" alt=""></p>
<h3 id="那怎么保证呢？"><a href="#那怎么保证呢？" class="headerlink" title="那怎么保证呢？"></a>那怎么保证呢？</h3><p>一般我是这么回答的：</p>
<p>帅气面试官您好，一般<strong>幂等</strong>，我会<strong>分场景去考虑</strong>，看是<strong>强校验</strong>还是<strong>弱校验</strong>，比如跟金钱相关的场景那就很关键呀，就做强校验，别不是很重要的场景做弱校验。</p>
<h4 id="强校验："><a href="#强校验：" class="headerlink" title="强校验："></a>强校验：</h4><p>比如你监听到用户支付成功的消息，你监听到了去加 GMV 是不是要调用加钱的接口，那加钱接口下面再调用一个加流水的接口，<strong>两个放在一个事务，成功一起成功失败一起失败</strong>。</p>
<p>每次消息过来都要拿着<strong>订单号+业务场景这样的唯一标识</strong>（比如天猫双十一活动）去流水表查，看看有没有这条流水，有就直接 return 不要走下面的流程了，没有就执行后面的逻辑。</p>
<p>之所以用<strong>流水表</strong>，是因为涉及到金钱这样的活动，有啥问题后面也可以去流水表<strong>对账</strong>，还有就是帮助开发人员定位问题。</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 强校验幂等伪代码演示，这都是简单的伪代码，真实情况复杂一点，但是大的逻辑是这样。
 * @param orderId
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span>String orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 查询这个订单是否存在这个活动加 GMV 的流水</span>
        Object gmvFlow <span class="token operator">=</span> <span class="token function">getFlowByOrderId</span><span class="token punctuation">(</span><span class="token string">"addGmv"</span> <span class="token operator">+</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Objects<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>gmvFlow<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 不存在流水，去加 GMV 和流水，注意这两个在一个事务的，回滚就一起回滚了。</span>
            <span class="token function">addGmvAndFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 存在流水证明加过了，返回就好了。</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 发送异常，触发消息队列重试机制。</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="弱校验："><a href="#弱校验：" class="headerlink" title="弱校验："></a>弱校验：</h4><p>这个简单，一些不重要的场景，比如给谁发短信啥的，我就把这个 Id + 场景唯一标识作为 <strong>Redis</strong> 的 Key ，放到缓存里面失效时间看你场景，<strong>一定时间内</strong>的这个消息就去 Redis 判断。</p>
<p>用 KV 就算消息丢了可能这样的场景也没关系，反正丢条<strong>无关痛痒</strong>的通知短信嘛（你敢说你没验证码短信丢失的情况？）。<br><img src="https://s1.ax1x.com/2020/05/09/YMGpM4.jpg" alt=""></p>
<p>还有很多公司的弱校验用 <strong>Token</strong> 啊什么的，反正花样很多，但是<strong>重要的场景一定要强校验</strong>，真正查问题的时候没有在磁盘持久化的数据，心里还是空空的，就像你和女朋友分开的时候的心里状态一样。（我单身的怎么知道这种感觉？猜的）</p>
<h3 id="你们有接触过消息顺序消费这样的场景么？你怎么保证的？"><a href="#你们有接触过消息顺序消费这样的场景么？你怎么保证的？" class="headerlink" title="你们有接触过消息顺序消费这样的场景么？你怎么保证的？"></a>你们有接触过消息顺序消费这样的场景么？你怎么保证的？</h3><p>没有！over ！ </p>
<p>乖，你肯定不能说没有啊，就是算真的没有，你都要说有！</p>
<blockquote>
<p><strong>Tips：</strong>但是说实话<strong>顺序消费</strong>这里很难介绍，开发过程中这样的场景不多，网上更多的都是介绍 <code>binlog</code> 的同步，好像更多的场景就没了。</p>
</blockquote>
<p>一般都是<strong>同个业务场景下不同几个操作的消息同时过去</strong>，本身顺序是对的，但是你发出去的时候同时发出去了，消费的时候却乱掉了，这样就有问题了。</p>
<p>我之前做电商活动也是有这样的例子，我们都知道数据量大的时候数据同步压力还是很大的，有时候数据量大的表需要同步几个亿的数据。（并不是主从同步，主从延迟大的话会有问题，可能是从数据库或者主数据库同步到<strong>备库</strong>）</p>
<p>这种情况我们都是怼到队列里面去，然后慢慢消费的，那问题就来了呀，我们在数据库同时对一个 Id 的数据进行了增、改、删三个操作，但是你消息发过去消费的时候变成了改，删、增，这样数据就不对了。</p>
<p>本来一条数据应该删掉了，结果在你那却还在，这不是<strong>出大问题</strong>！</p>
<p><img src="https://s1.ax1x.com/2020/05/09/YMGFd1.jpg" alt=""></p>
<p>两者的结果是不是完全不一样了 <strong>↑</strong></p>
<h3 id="那你怎么解决呢？"><a href="#那你怎么解决呢？" class="headerlink" title="那你怎么解决呢？"></a>那你怎么解决呢？</h3><p>我简单的说一下我们使用的 <strong>RocketMQ</strong> 里面的一个简单实现吧。</p>
<p>生产者消费者一般需要保证顺序消息的话，可能就是一个业务场景下的，比如订单的创建、支付、发货、收货。</p>
<p>那这些东西是不是一个订单号呢？一个订单的肯定是一个订单号的说，那简单了呀。</p>
<p><strong>一个 Topic 下有多个队列</strong>，为了保证发送有序，<strong>RocketMQ</strong> 提供了 <strong>MessageQueueSelector</strong> 队列选择机制，它有三种实现：</p>
<p><img src="https://s1.ax1x.com/2020/05/09/YMGEi6.png" alt=""></p>
<p>我们可使用 <strong>Hash 取模法</strong>，让同一个订单发送到同一个队列中，再使用同步发送，只有同个订单的创建消息发送成功，再发送支付消息。这样，我们保证了发送有序。</p>
<p><strong>RocketMQ</strong> 的 Topic 内的队列机制，可以保证存储满足 <strong>FIFO</strong>（First Input First Output ，简单说就是指先进先出），剩下的只需要消费者顺序消费即可。</p>
<p><strong>RocketMQ</strong> 仅保证顺序发送，顺序消费由消费者业务保证！！！</p>
<p>这里很好理解，一个订单你发送的时候放到一个队列里面去，你同一个的订单号 Hash 一下是不是还是一样的结果，那肯定是一个消费者消费，那顺序是不是就保证了？</p>
<p>真正的顺序消费不同的中间件都有自己的不同实现我这里就举个例子，大家思路理解下。</p>
<blockquote>
<p><strong>Tips：</strong>有人问我，一个队列有序出去，一个消费者消费不就好了，我想说的是<strong>消费者是多线程</strong>的，你消息是有序的给它的，你能保证它是有序的处理的？还是一个消费成功了再发下一个<strong>稳妥</strong>。</p>
</blockquote>
<h3 id="你能跟我聊一下分布式事务么？"><a href="#你能跟我聊一下分布式事务么？" class="headerlink" title="你能跟我聊一下分布式事务么？"></a>你能跟我聊一下分布式事务么？</h3><p><strong>分布式事务</strong>在现在遍地都是分布式部署的系统中几乎是必要的。</p>
<p>我们先聊一下啥是<strong>事务</strong>？</p>
<p><strong>分布式事务</strong>、<strong>事务隔离级别</strong>、<strong>ACID</strong> 我相信大家这些东西都耳熟能详了，那什么是事务呢？</p>
<h4 id="概念："><a href="#概念：" class="headerlink" title="概念："></a>概念：</h4><blockquote>
<p><strong>一般是指要做的或所做的事情。</strong></p>
<p>在计算机术语中是指访问并可能更新数据库中各种数据项的一个程序执行单元（unit）。</p>
<p>事务通常由高级数据库操纵语言或编程语言（如 SQL ，C++ 或 Java ）书写的用户程序的执行所引起，并用形如 <strong>begin transaction</strong> 和 <strong>end transaction</strong> 语句（或函数调用）来界定。</p>
<p>事务由事务开始（<strong>begin transaction</strong>）和事务结束（<strong>end transaction</strong>）之间执行的全体操作组成。</p>
</blockquote>
<h4 id="特性："><a href="#特性：" class="headerlink" title="特性："></a>特性：</h4><blockquote>
<p>事务是恢复和并发控制的基本单位。</p>
<p>事务应该具有 4 个属性：<strong>原子性、一致性、隔离性、持久性</strong>。这四个属性通常称为 <strong>ACID 特性</strong>。</p>
<p><strong>原子性（Atomicity）：</strong>一个事务是一个不可分割的工作单位，事务中的操作要么都执行，要么都不执行。</p>
<p><strong>一致性（Consistency）：</strong>事务必须是使数据库从一个一致性状态变到另一个一致性状态。一致性与原子性是密切相关的。</p>
<p><strong>隔离性（Isolation）：</strong>一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。</p>
<p><strong>持久性（Durability）：持久性也称永久性（Permanence）</strong>，指一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响。</p>
</blockquote>
<p>那有同学还是不理解，我总结了一下就是：<strong>事务就是一系列操作，要么同时成功，要么同时失败。</strong>然后会从事务的 <strong>ACID</strong> 特性<strong>（原子性、一致性、隔离性、持久性）展开叙述</strong>。</p>
<p>事务就是为了保证一系列操作可以正常执行，它必须同时满足 <strong>ACID</strong> 特性。</p>
<h3 id="那什么是分布式事务呢？"><a href="#那什么是分布式事务呢？" class="headerlink" title="那什么是分布式事务呢？"></a>那什么是分布式事务呢？</h3><p>大家可以想一下，你下单流程可能涉及到 10 多个环节，你下单付钱都成功了，但是你优惠券扣减失败了，积分新增失败了，前者公司会被薅羊毛，后者用户会不开心，但是<strong>这些都在不同的服务怎么保证大家都成功呢</strong>？</p>
<p>聪明，<strong>分布式事务</strong>，你看你都会抢答了！</p>
<blockquote>
<p><strong>Tips：</strong>真实的应用场景可能比我介绍的场景复杂数倍，我只是为了举例方便一下大家理解所以用了很简单的例子。</p>
</blockquote>
<p>我接触和了解到的分布式事务大概分为：</p>
<ul>
<li>2PC（两段式提交）</li>
<li>3PC（三段式提交）</li>
<li>TCC（Try、Confirm、Cancel）</li>
<li>最大努力通知</li>
<li>XA</li>
<li>本地消息表（ebay 研发出的）</li>
<li>半消息/最终一致性（RocketMQ）</li>
</ul>
<p>这里我就介绍下最简单的 <strong>2PC（两段式）</strong>，以及大家以后可能比较常用的<strong>半消息事务</strong>也就是<strong>最终一致性</strong>，目的是让大家理解下分布式事务里面<strong>消息中间件的作用</strong>，别的事务都大同小异，都有很多优点。</p>
<p>当然也都有<strong>种种弊端：</strong></p>
<p>例如<strong>长时间锁定数据库资源</strong>，导致系统的<strong>响应不快</strong>，<strong>并发上不去</strong>。</p>
<p>网络抖动出现<strong>脑裂</strong>情况，导致事物参与者，不能很好地执行协调者的指令，导致<strong>数据不一致</strong>。</p>
<p><strong>单点故障</strong>：例如事物协调者，在某一时刻宕机，虽然可以通过选举机制产生新的 Leader ，但是这过程中，必然出现问题，而 TCC ，只有强悍的技术团队，才能支持开发，<strong>成本太高</strong>。</p>
<p>不多 BB 了，我们先来介绍这个 2PC 吧。</p>
<p><strong>2PC（两段式提交）：</strong></p>
<p><img src="https://s1.ax1x.com/2020/05/09/YMGZRO.jpg" alt="2PC"></p>
<p><strong>2pc（两段式提交）</strong>可以说是分布式事务的最开始的样子了，像极了<strong>媒婆</strong>，就是通过消息中间件协调多个系统，在两个系统操作事务的时候都锁定资源但是不提交事务，等两者都准备好了，告诉消息中间件，然后再分别提交事务。</p>
<p><strong>但是我不知道大家看到问题所在没有？</strong></p>
<p>是的你可能已经发现了，如果 A 系统事务提交成功了，但是 B 系统在提交的时候网络波动或者各种原因提交失败了，其实还是会失败的。</p>
<p><strong>3PC（三段式提交）：</strong></p>
<p><img src="https://s1.ax1x.com/2020/05/09/YMGNQg.png" alt="3PC"></p>
<p>3PC 是 2PC 的改进版本，与 2PC 不同的是，3PC 有两个改动点：</p>
<ul>
<li>引入超时机制。同时在协调者和参与者中都引入超时机制。</li>
<li>在第一阶段和第二阶段中插入一个准备阶段。保证了在最后提交阶段之前各参与节点的状态是一致的。</li>
</ul>
<p>也就是说，除了引入超时机制之外，3PC 把 2PC 的准备阶段再次一分为二，这样三段式提交就有 <code>CanCommit</code> 、<code>PreCommit</code> 、<code>DoCommit</code> 三个阶段。</p>
<p><strong>最终一致性：</strong></p>
<p><img src="https://s1.ax1x.com/2020/05/09/YMGUyQ.jpg" alt="最终一致性"></p>
<p>整个流程中，我们能保证是：</p>
<ul>
<li><p>业务主动方本地事务提交失败，业务被动方不会收到消息的投递。</p>
</li>
<li><p>只要业务主动方本地事务执行成功，那么消息服务一定会投递消息给下游的业务被动方，并最终保证业务被动方一定能成功消费该消息（消费成功或失败，即最终一定会有一个最终态）。</p>
</li>
</ul>
<p>不过呢技术就是这样，<strong>各种极端的情况我们都需要考虑</strong>，也很难有完美的方案，所以才会有这么多的方案<strong>三段式</strong>、<strong>TCC</strong> 、<strong>最大努力通知</strong>等等分布式事务方案，大家只需要知道为啥要做，做了有啥好处，有啥坏处，在实际开发的时候都注意下就好好了，<strong>系统都是根据业务场景设计出来的，离开业务的技术没有意义，离开技术的业务没有底气</strong>。</p>
<p>还是那句话：<strong>没有最完美的系统，只有最适合的系统。</strong></p>
<h2 id="面试结束"><a href="#面试结束" class="headerlink" title="面试结束"></a>面试结束</h2><h3 id="小伙子看不出来啊，还是有点东西的嘛，这几个点都回答的不错，明天你能跟我聊一下-RocketMQ-么？"><a href="#小伙子看不出来啊，还是有点东西的嘛，这几个点都回答的不错，明天你能跟我聊一下-RocketMQ-么？" class="headerlink" title="小伙子看不出来啊，还是有点东西的嘛，这几个点都回答的不错，明天你能跟我聊一下 RocketMQ 么？"></a>小伙子看不出来啊，还是有点东西的嘛，这几个点都回答的不错，明天你能跟我聊一下 RocketMQ 么？</h3><p>嗯嗯好的面试官，不过不确定能不能一口气说完，毕竟还没开始<strong>白嫖</strong>。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><strong>消息队列的基础知识</strong>我就先介绍这么多，消息队列在面试里面基本上也是跟我前面写的 <strong>Redis</strong> 一样必问的。</p>
<p>面试的思路还是一样，<strong>要知其然，也要知其所以然，就是要知道为啥用，用了有啥好处，有啥坑。</strong></p>
<p>面试官不喜欢<strong>只知道用</strong>的，你只会用那哪天线上出问题怎么办？你难道在旁边拜佛？</p>
<p><img src="https://s1.ax1x.com/2020/05/09/YMG0wn.jpg" alt=""></p>
<p>好了，以上就是这篇文章的全部内容了，能看到这里的人呀，都是<strong>人才</strong>，祝各位看官都能成为 offer 收割机^∨^。</p>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.niewenjun.com" rel="external nofollow noreferrer">wenjun</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.niewenjun.com/2020/05/09/fen-bu-shi/xiao-xi-dui-lie-ji-chu/">https://www.niewenjun.com/2020/05/09/fen-bu-shi/xiao-xi-dui-lie-ji-chu/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://www.niewenjun.com" target="_blank">wenjun</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">
                                    <span class="chip bg-color">消息队列</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/05/09/fen-bu-shi/rocketmq/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="RocketMQ">
                        
                        <span class="card-title">RocketMQ</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            RocketMQ前言消息队列在互联网技术存储方面使用如此广泛，几乎所有的后端技术面试官都要在消息队列的使用和原理方面对小伙伴们进行 360° 的刁难。作为一个在互联网公司面一次拿一次 offer 的面霸，打败了无数竞争对手，每次都只能看到无
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-05-09
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" class="post-category">
                                    分布式
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">
                        <span class="chip bg-color">消息队列</span>
                    </a>
                    
                    <a href="/tags/RocketMQ/">
                        <span class="chip bg-color">RocketMQ</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/05/08/linux/shen-ru-pou-xi-linux-io-yuan-li-he-ji-chong-ling-kao-bei-ji-zhi-de-shi-xian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/16.jpg" class="responsive-img" alt="深入剖析Linux IO原理和几种零拷贝机制的实现">
                        
                        <span class="card-title">深入剖析Linux IO原理和几种零拷贝机制的实现</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            深入剖析 Linux IO 原理和几种零拷贝机制的实现前言零拷贝（Zero-copy）技术指在计算机执行操作时，CPU 不需要先将数据从一个内存区域复制到另一个内存区域，从而可以减少上下文切换以及 CPU 的拷贝时间。它的作用是在数据报从网
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-05-08
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Linux/" class="post-category">
                                    Linux
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Linux-IO/">
                        <span class="chip bg-color">Linux IO</span>
                    </a>
                    
                    <a href="/tags/%E9%9B%B6%E6%8B%B7%E8%B4%9D/">
                        <span class="chip bg-color">零拷贝</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="https://www.niewenjun.com" target="_blank"></a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "4";
                    var startDate = "12";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wenjunnie" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1287018840@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1287018840" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1287018840" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
